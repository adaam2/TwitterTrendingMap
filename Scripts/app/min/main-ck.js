function subscribeGlobalStream(){twitterHub.server.subscribeToStreamGroup("Global").done(function(e){e===!0&&(startBtn.prop("disabled",!0),stopBtn.prop("disabled",!1))})}function unsubscribeGlobalStream(){twitterHub.server.unsubscribeFromStreamGroup("Global").done(function(){stopBtn.prop("disabled",!0),startBtn.prop("disabled",!1)})}var map,mc,tweetLayer,guids=[],counter=0,bounds=new google.maps.LatLngBounds,twitterHub=$.connection.geoFeedHub,startBtn=$("#startStream"),stopBtn=$("#stopStream"),svgshape=document.getElementById("notification-shape"),stylez=[{featureType:"road",elementType:"geometry",stylers:[{lightness:100},{visibility:"simplified"}]},{featureType:"water",elementType:"geometry",stylers:[{visibility:"on"},{color:"#C6E2FF"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{color:"#C5E3BF"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#D1D1B8"}]}],map_options={zoom:7,backgroundColor:"#A3A3A3",disableDoubleClickZoom:!0,center:new google.maps.LatLng(53,-.2),mapTypeID:google.maps.MapTypeId.HYBRID,keyboardShortcuts:!1,overviewMapControl:!1,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP]},panControl:!1,scrollwheel:!1,streetViewControl:!1,styles:stylez},guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return e()+e()}}(),buildTweetWindow=function(e){var t=new Date(e.CreatedAt),o=t.getDate(),a=t.getMonth()+1,n=t.getFullYear(),s=t.toTimeString(),r=o+"/"+a+"/"+n,i='<div class="tweet">        <div class="header">        <div class="avatar"><a target="_blank" href="https://www.twitter.com/'+e.User+'"><img src="'+e.ImageUrl+'" alt="'+e.User+'s profile picture"/></a></div>        <div class="screen-name"><span class="handle">@'+e.User+'</span><span class="time-ago"><time class="timeago" datetime="'+e.CreatedAt+'">'+r+'</time></span></div>        </div>        <div class="body"><p>'+e.Text+'</p></div>        <div class="footer">'+r+" "+s+"</div>        </div>";return i};$(function(){$("#autocomplete").geocomplete({map:"#map-canvas",mapOptions:map_options}).bind("geocode:result",function(e,t){var o=new google.maps.LatLngBounds(t.geometry.viewport.getSouthWest(),t.geometry.viewport.getNorthEast());map.fitBounds(o);var a=new NotificationFx({message:'<span class="icon"><i class="fa fa-map-marker fa-3x"></i></span><p>Now only showing results for '+t.name+" and surrounding areas.</p>",layout:"bar",customClass:"geo",effect:"exploader",ttl:15e3,type:"notice"});a.show()}),$("#find").click(function(){$("#autocomplete").trigger("geocode")}),map=$("#autocomplete").geocomplete("map"),map.set("streetViewControl",!0),map.mapTypeControl=!1;var e={gridSize:100,batchSize:3e3,batchSizeIE:200,maxZoom:12,averageCenter:!1};mc=new MarkerClusterer(map,[],e),twitterHub.client.BroadcastNewUserToHub=function(e){console.log(e)},twitterHub.client.broadcastTweetMessage=function(e){counter++,$("#tweet-count").html(counter);var t=new google.maps.Marker({position:new google.maps.LatLng(e.Latitude,e.Longitude),title:e.Text+" by @"+e.User,map:map}),o=new google.maps.InfoWindow({content:buildTweetWindow(e)});$("time.timeago").timeago(),google.maps.event.addListener(t,"click",function(){map.panTo(t.getPosition()),o.open(map,t)}),mc.addMarker(t);var a=$("ul.live-tweets li").size(),n=10,s='<li class="tweet-item"><span class="tweet-avatar"><a target="_blank" href="https://www.twitter.com/'+e.User+'"><img alt="'+e.User+'s profile picture" class="img-thumbnail" src="'+e.ImageUrl+'"/></a></span><span class="tweet-content">'+e.Text+'</span><span class="tweet-author">@'+e.User+"</span></li>";$("ul.live-tweets").prepend(s)},twitterHub.client.debug=function(e){console.log(e)},twitterHub.client.broadcastLog=function(e){$("#error").modal(),$(".errorMessage").html(e)},$.connection.hub.start().done(function(){subscribeGlobalStream(),stopBtn.click(function(e){unsubscribeGlobalStream(),e.preventDefault();var t=new NotificationFx({message:'<span class="icon icon-settings"></span><p>The stream has been stopped. You will not receive any tweets on the map, nor will you be able to see any incoming trends until you restart the stream.</p>',layout:"bar",customClass:"stop",effect:"exploader",ttl:6e3,type:"notice"});t.show()}),startBtn.click(function(e){subscribeGlobalStream(),e.preventDefault();var t=new NotificationFx({message:'<span class="icon icon-settings"></span><p>You have started the stream. Incoming tweets and trends will match the current viewport of the map.</p>',layout:"bar",customClass:"start",effect:"exploader",ttl:6e3,type:"notice"});t.show()})});var t=$.connection.trendsAnalysisHub;t.client.broadcastTrend=function(e){console.log(e)},google.maps.event.addListener(map,"idle",function(e){google.maps.event.addListener(map,"bounds_changed",function(){var e=this.getBounds(),t=e.getSouthWest(),o=e.getNorthEast(),a=new google.maps.LatLng(o.lat(),t.lng()),n=new google.maps.LatLng(t.lat(),o.lng());twitterHub.server.changeStreamBounds({SouthEastLongitude:n.lng(),SouthEastLatitude:n.lat(),NorthWestLongitude:a.lng(),NorthWestLatitude:a.lat()}).done(function(){console.log("Bounds changed")}).fail(function(e){console.log("Bounds change failure. Error: "+e)})})})});