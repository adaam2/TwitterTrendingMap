function fitToUKBounds(e){var t=new google.maps.LatLng(49.955269,-8.164723),a=new google.maps.LatLng(60.6311,1.7425),o=new google.maps.LatLngBounds(t,a);e.fitBounds(o)}function subscribeGlobalStream(){twitterHub.server.subscribeToStreamGroup("Global").done(function(e){e===!0&&(startBtn.prop("disabled",!0),stopBtn.prop("disabled",!1))})}function unsubscribeGlobalStream(){twitterHub.server.unsubscribeFromStreamGroup("Global").done(function(){stopBtn.prop("disabled",!0),startBtn.prop("disabled",!1)})}function Initialize(){$("#autocomplete").geocomplete({map:"#map-canvas",mapOptions:map_options,markerOptions:{disabled:!0}}).bind("geocode:result",function(e,t){var a=new google.maps.LatLngBounds(t.geometry.viewport.getSouthWest(),t.geometry.viewport.getNorthEast());map.fitBounds(a);var o=new NotificationFx({message:'<span class="icon"><i class="fa fa-map-marker fa-3x"></i></span><p>Now only showing results for <strong>'+t.name+"</strong> and surrounding areas.</p>",layout:"bar",customClass:"geo",effect:"exploader",ttl:1e4,type:"notice"});o.show()}),$("#find").click(function(){$("#autocomplete").trigger("geocode")}),map=$("#autocomplete").geocomplete("map"),fitToUKBounds(map),tweetLayer=new CustomOverlay(map,!1),trendLayer=new CustomOverlay(map,!0),map.set("streetViewControl",!0),map.mapTypeControl=!1;var e={gridSize:100,batchSize:3e3,minimumClusterSize:1,batchSizeIE:200,maxZoom:12,averageCenter:!1,ignoreHidden:!0};mc=new MarkerClusterer(map,[],e)}var map,mc,tweetLayer,trendLayer,counter=0,bounds=new google.maps.LatLngBounds,twitterHub=$.connection.geoFeedHub,startBtn=$("#startStream"),stopBtn=$("#stopStream"),iconBase="http://dev.wherelionsroam.co.uk/",stylez=[{featureType:"road",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"geometry",stylers:[{visibility:"on"},{color:"#C6E2FF"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{color:"#C5E3BF"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#D1D1B8"}]}],map_options={backgroundColor:"#A3A3A3",disableDoubleClickZoom:!0,mapTypeID:google.maps.MapTypeId.HYBRID,keyboardShortcuts:!1,overviewMapControl:!1,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP]},panControl:!1,scrollwheel:!1,streetViewControl:!1,styles:stylez},buildTrendWindow=function(e){var t=e.tweets,a="<div class='trendTweetsWrapper'><h3>Tweets for "+e.title+"</h3><ul>";return $.each(e.data.tweets,function(e,t){a+="<li><div class='tweetbody'>"+t.Text+"</div><div class='tweetfoot'><span class='tweetlink'><a target='_blank' href='"+t.URL+"'>View on Twitter</a></span></div></li>"}),a+="</ul></div>"},buildTweetWindow=function(e){var t=new Date(e.CreatedAt),a=t.getDate(),o=t.getMonth()+1,n=t.getFullYear(),s=t.toTimeString(),i=a+"/"+o+"/"+n,r='<div class="tweet">        <div class="header">        <div class="avatar"><a target="_blank" href="https://www.twitter.com/'+e.User+'"><img src="'+e.ImageUrl+'" alt="'+e.User+'s profile picture"/></a></div>        <div class="screen-name"><span class="handle">@'+e.User+'</span><span class="time-ago"><time class="timeago" datetime="'+e.CreatedAt+'">'+i+'</time></span></div>        </div>        <div class="body"><p>'+e.Text+'</p></div>        <div class="footer">'+i+" "+s+"</div>        </div>";return r};$(function(){Initialize(),twitterHub.client.BroadcastNewUserToHub=function(e){console.log(e)},twitterHub.client.broadcastTweetMessage=function(e){counter++,$("#tweet-count").html(counter);var t=new google.maps.Marker({position:new google.maps.LatLng(e.Latitude,e.Longitude),title:e.Text+" by @"+e.User});tweetLayer.hidden&&t.setVisible(!1),tweetLayer.addOverlay(t);var a=new google.maps.InfoWindow({content:buildTweetWindow(e)});$("time.timeago").timeago(),google.maps.event.addListener(t,"click",function(){map.panTo(t.getPosition()),a.open(map,t)}),mc.addMarker(t),mc.repaint();var o=$("ul.live-tweets li").size(),n=50,s='<li class="tweet-item"><span class="tweet-avatar"><a target="_blank" href="https://www.twitter.com/'+e.User+'"><img alt="'+e.User+'s profile picture" class="img-thumbnail" src="'+e.ImageUrl+'"/></a></span><span class="tweet-content">'+e.Text+'</span><span class="tweet-author">@'+e.User+"</span></li>";n>o?$("ul.live-tweets").prepend(s):($("ul.live-tweets li:last-child").remove(),$("ul.live-tweets").prepend(s))},twitterHub.client.broadcastLog=function(e){console.log(e)},$("#switch").click(function(){$(".loader").show("fade",100),setTimeout(function(){trendLayer.getState()?(mc.setMap(null),tweetLayer.hide(),trendLayer.show(),$("#switch").removeClass("btn-warning"),$("#switch").addClass("btn-default"),$("#switch").html("Switch to Tweets")):(mc.repaint(),mc.setMap(map),trendLayer.hide(),tweetLayer.show(),$("#switch").addClass("btn-warning"),$("#switch").removeClass("btn-default"),$("#switch").html("Switch to Trends")),$(".loader").hide("fade",100)},600)}),$("#reset-map").click(function(){fitToUKBounds(map)}),$.connection.hub.start().done(function(){subscribeGlobalStream(),stopBtn.click(function(e){unsubscribeGlobalStream(),e.preventDefault();var t=new NotificationFx({message:'<span class="icon icon-settings"></span><p>The stream has been stopped. You will not receive any tweets on the map, nor will you be able to see any incoming trends until you restart the stream.</p>',layout:"bar",customClass:"stop",effect:"exploader",ttl:6e3,type:"notice"});t.show()}),startBtn.click(function(e){subscribeGlobalStream(),e.preventDefault();var t=new NotificationFx({message:'<span class="icon icon-settings"></span><p>You have started the stream. Incoming tweets and trends will match the current viewport of the map.</p>',layout:"bar",customClass:"start",effect:"exploader",ttl:6e3,type:"notice"});t.show()})}),twitterHub.client.broadcastTrend=function(e){var t=new google.maps.Marker({position:new google.maps.LatLng(e.averageCenter.Longitude,e.averageCenter.Latitude),title:e.Name,data:{tweets:e.tweets,type:e.entityType,miscInfo:e.MiscInformation},icon:"/img/trends/"+e.entityType+".png"});console.log(t.data);var a=new google.maps.InfoWindow({content:buildTrendWindow(t),maxWidth:400,pixelOffset:new google.maps.Size(15,15)});google.maps.event.addListener(t,"click",function(){map.panTo(t.getPosition()),a.open(map,t)}),trendLayer.addOverlay(t)},google.maps.event.addListener(map,"idle",function(e){google.maps.event.addListener(map,"bounds_changed",function(){var e=this.getBounds(),t=e.getSouthWest(),a=e.getNorthEast(),o=new google.maps.LatLng(a.lat(),t.lng()),n=new google.maps.LatLng(t.lat(),a.lng());twitterHub.server.changeStreamBounds({SouthEastLongitude:n.lng(),SouthEastLatitude:n.lat(),NorthWestLongitude:o.lng(),NorthWestLatitude:o.lat()},$.connection.hub.id).done(function(){console.log("Bounds changed")}).fail(function(e){console.log("Bounds change failure. Error: "+e)})})})});